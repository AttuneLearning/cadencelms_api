### ISS-003: "My Progress" Link Causes Infinite Loading Loop on Non-Learner Dashboards

**Priority:** high
**Type:** bug
**Status:** completed
**Completed:** 2026-01-12
**Assigned:** UI Agent
**Dependencies:** None  

**Description:**
The "My Progress" link appears in the sidebar navigation on all dashboards (Staff, Admin, Learner) but should only be visible/accessible on the Learner dashboard. When clicked from the Staff dashboard (`/staff/dashboard`), it causes an infinite loading loop with module loading errors and authentication failures, making the UI completely unusable until logout/login.

**Current Behavior:**
1. User is logged in as `admin@lms.edu` (system-admin with multi-userType)
2. On `/staff/dashboard`, "My Progress" link is visible in sidebar
3. Clicking "My Progress" navigates to `/learner/progress`
4. Route is protected by `<LearnerOnlyRoute>` guard
5. Guard fails/redirects repeatedly, causing infinite loop
6. UI becomes unresponsive with these errors looping:
   - Authentication issue appears first
   - Module loading failures: `index.tsx`, `AppLayout.tsx`, `auth/ui/index.ts`
   - Screen objects continuously load and crash
7. Only recovery is logout/login

**Root Cause Analysis Needed:**
1. **Navigation Filtering:** Why is learner-only link visible on staff dashboard?
   - In `navItems.ts`, "My Progress" has `userTypes: ['learner']`
   - In `Sidebar.tsx`, filtering should hide items not matching `primaryUserType`
   - Need to verify filtering logic for context-aware navigation
   
2. **Route Guard Failure:** Why does `<LearnerOnlyRoute>` cause infinite loop instead of graceful redirect?
   - Should redirect to appropriate dashboard or show error
   - Need to investigate redirect logic in `LearnerOnlyRoute` component
   - Should it auto-switch to learner dashboard if user has learner userType?

**Acceptance Criteria:**

**Primary Fix (Navigation Filtering):**
- [ ] "My Progress" link is HIDDEN when not on learner dashboard
- [ ] Verify filtering logic uses current dashboard context (not just primaryUserType)
- [ ] Similar learner-only links are also properly filtered
- [ ] Admin-only links are HIDDEN when not on admin dashboard
- [ ] All navigation items respect dashboard context

**Secondary Fix (Graceful Failure):**
- [ ] If user somehow accesses `/learner/progress` from wrong dashboard:
  - [ ] Option A: Auto-redirect to learner dashboard (if user has learner userType)
  - [ ] Option B: Show friendly error message and redirect to current dashboard
  - [ ] Option C: Gray out link but allow navigation with auto-context-switch
- [ ] No infinite loops under any circumstances
- [ ] Clear error messaging if access denied
- [ ] Route guards never cause module loading failures

**Testing Requirements:**
- [ ] Test with multi-userType user (learner + staff + admin)
- [ ] Test clicking learner-only links from staff dashboard
- [ ] Test clicking staff-only links from learner dashboard  
- [ ] Test clicking admin-only links from non-admin dashboards
- [ ] Test graceful failure when route guard rejects access
- [ ] Verify no console errors or infinite loops
- [ ] Test that correct links appear on each dashboard

**Related Files:**
- `src/widgets/sidebar/config/navItems.ts` - Navigation item definitions
- `src/widgets/sidebar/Sidebar.tsx` - Sidebar filtering logic (lines 84-104)
- `src/app/router/index.tsx` - Route definitions and guards (line 223)
- `src/app/router/guards/LearnerOnlyRoute.tsx` - Route guard component
- `src/widgets/header/Header.tsx` - Dashboard context detection logic

**API Coordination Required:**
- [x] Create thread to ask API team about route for "My Progress": What is the exact path?
- [x] Confirm if route should be dashboard-specific or context-aware

**API ANSWERS (2026-01-12 from API Agent):**

1. **"My Progress" API route:** `GET /api/v2/users/me/progress`
   - Defined at `src/routes/users.routes.ts:54`
   - Returns comprehensive progress summary for current user (learner)
   - This is a user-centric endpoint, not dashboard-specific

2. **Dashboard-specific vs context-aware:**
   - The API endpoint is **user-centric** (works for any authenticated user)
   - The **UI route** `/learner/progress` is dashboard-specific
   - API doesn't care which dashboard you're on - it returns progress for the logged-in user
   - The infinite loop is a **UI route guard issue**, not an API issue
   - If user has learner userType, API will return their progress regardless of current dashboard

3. **Recommendation:**
   - API is working correctly - returns progress for authenticated user
   - UI should either: (a) hide link on non-learner dashboards, or (b) auto-switch to learner dashboard when clicked
   - Route guard should NOT cause infinite loop - should gracefully redirect or show error

**Notes:**
- This is similar to the previous THR-AUTH-001 issue with admin navigation links not appearing
- The inverse problem: links appearing when they shouldn't
- Need comprehensive audit of which links belong on which dashboards
- Consider creating a dashboard-aware navigation configuration
- User preference on fix approach needed: hide, gray-out, or auto-switch?

**Questions for Human:**
1. Should learner-specific links be completely hidden or grayed out on staff/admin dashboards?
2. Should clicking a cross-dashboard link auto-switch to the appropriate dashboard?
3. Are there other links showing incorrectly that you've noticed?
4. What should happen if a staff user (without learner role) tries to access `/learner/progress`?

---

### HUMAN ANSWERS (2026-01-12)

**5. "My Courses" link behavior:** ✅ DECIDED
- If user does NOT have `learner` userType: **Gray out the link** (disabled, not clickable)
- If user HAS `learner` userType: **Leave active** and auto-switch to `learnerDashboard.MyCourses` page when clicked

**6. "My Progress" link behavior:** ✅ DECIDED  
- If user does NOT have learner account: **Gray out the link** (disabled)
- If user HAS learner account: **Leave active** and auto-switch to `learnerDashboard.MyProgress` page when clicked

**7. Access denial for staff without learner userType:** ✅ DECIDED
- The link should be **grayed out** if staff user doesn't have `learner` **userType**
- Important distinction: Check **userType** (not role - roles are department-specific)
- This applies to all learner-specific links on non-learner dashboards

---

