### ISS-001: Profile Page - Complete Implementation with IPerson Type

**Priority:** high
**Type:** feature
**Status:** ✅ COMPLETED (git commit fa63fe9 - Phase 4)
**Assigned:** Both (UI Agent + API Agent coordination)
**Dependencies:** API must implement IPerson type first (RESOLVED)  

**Description:**
Profile page currently 404s on all dashboards. Need to implement full profile management with new IPerson type structure that supports context-specific display names and comprehensive personal information.

**User Experience Requirements:**

1. **Route Structure:** Per-dashboard routes
   - `/learner/profile` - Learner profile view
   - `/staff/profile` - Staff profile view  
   - `/admin/profile` - Admin profile view (minimal, uses staff display name)

2. **Edit Workflow:**
   - Each field has an "Edit" button
   - Field is read-only until Edit is pressed
   - Auto-save every 2 minutes while editing
   - After auto-save, field returns to read-only and Edit button unpressed
   - Clear visual indication that changes have been saved
   - Do NOT warn on unsaved changes (auto-save handles it)
   - ONLY warn if there's a current error state

3. **Context-Specific Display:**
   - Staff users can have different DisplayName for Staff vs Learner contexts
   - Example: "Dr. Smith" when acting as staff, "John S." when acting as learner
   - Admin userType uses the staff displayName (no separate admin display name)

**API Requirements (for API Agent):**

### New Type: IPerson

```typescript
interface IPerson {
  // Name fields
  firstName: string;
  middleName?: string;
  lastName: string;
  
  // Context-specific display names
  displayNames: {
    learner?: string;  // Display name when in learner context
    staff?: string;    // Display name when in staff context
    // Admin uses staff displayName
  };
  
  // Contact
  emails: IEmail[];
  
  // Address
  addresses: IAddress[];
  
  // Identity
  last4SSN?: string;
  dateOfBirth?: Date;
  identifications: IIdentification[];
  
  // Profile
  bio?: string;
  avatar?: string; // URL or file path
  
  // Preferences
  timezone?: string;
  languagePreference?: string;
}

interface IEmail {
  email: string;
  type: 'primary' | 'secondary' | 'work' | 'personal';
  verified: boolean;
}

interface IAddress {
  // Geographic address
  street1: string;
  street2?: string;
  city: string;
  state: string;
  postalCode: string;
  country: string;
  
  // Metadata
  type: 'business' | 'home' | 'other';
  isPrimary: boolean;
}

interface IIdentification {
  idNumber: string; // Encrypted/hashed
  idType: 'passport' | 'drivers-license' | 'state-id' | 'student-id' | 'other';
  issuingAuthority?: string;
  expirationDate?: Date;
}
```

### API Endpoints Needed

**Profile Management:**
- `GET /api/v2/users/me/person` - Get IPerson data for current user
- `PUT /api/v2/users/me/person` - Update IPerson data (partial updates supported)
- `GET /api/v2/users/me/person/avatar` - Get avatar
- `POST /api/v2/users/me/person/avatar` - Upload avatar

**Password Management:**
- `POST /api/v2/users/me/password` - Change user password (requires current password)
- `POST /api/v2/admin/me/password` - Change admin session password (requires current admin password)

---

### API ANSWERS (2026-01-12 from API Agent)

**CURRENT STATE - What EXISTS:**

1. **`GET /api/v2/users/me`** - ✅ EXISTS
   - Contract: `contracts/api/users.contract.ts` lines 24-110
   - Returns: `id, email, firstName, lastName, role, status, profileImage, phone, createdAt, lastLoginAt, updatedAt`
   - Role-specific fields: departments, permissions, departmentRoles (staff); studentId, enrollments (learner)

2. **`PUT /api/v2/users/me`** - ✅ EXISTS  
   - Contract: `contracts/api/users.contract.ts` lines 115-200
   - Allows updating: firstName, lastName, phone, profileImage (URL only)
   - Does NOT allow: role, permissions, department changes, password

3. **`GET /api/v2/users/me/progress`** - ✅ EXISTS
   - Route: `src/routes/users.routes.ts:54`
   - Returns learner progress summary

**CURRENT STATE - What does NOT EXIST (API work needed):**

1. **`IPerson` type** - ❌ NOT IMPLEMENTED
   - No `person.model.ts` file exists
   - No `person.contract.ts` file exists  
   - Current profile data is split: User model has basic info, Staff/Learner models have role-specific fields
   - **Recommendation:** Decide if IPerson should be a new embedded document or if existing fields suffice

2. **`GET/PUT /users/me/person`** - ❌ NOT IMPLEMENTED
   - These endpoints do not exist
   - Current approach uses `/users/me` for profile data
   - **Question for Human:** Do we need separate `/person` endpoints or can we extend `/users/me`?

3. **Avatar Upload** - ❌ NOT IMPLEMENTED
   - No `POST /users/me/avatar` endpoint exists
   - Current `profileImage` field is URL-only (external hosting assumed)
   - **Question for Human:** Do we need API-hosted avatar storage or use external service (S3, Cloudinary)?

4. **Password Change** - ⚠️ PARTIAL
   - No dedicated user password change endpoint exists
   - Escalation password validation exists for admin sessions (`src/validators/escalation.validator.ts`)
   - **Needs Implementation:** `POST /users/me/password` for regular password change

5. **Context-specific displayNames** - ❌ NOT IMPLEMENTED
   - Current models don't have `displayNames.staff` / `displayNames.learner` structure
   - Would require model schema updates

**SUMMARY FOR UI TEAM:**

⚠️ **ISS-001 is BLOCKED on API work.** The following must be implemented before UI can proceed:

| Endpoint | Status | Priority |
|----------|--------|----------|
| GET /users/me | ✅ Ready | - |
| PUT /users/me | ✅ Ready | - |
| IPerson type design | ❌ Needs decision | High |
| /users/me/person endpoints | ❌ Needs implementation | High |
| Avatar upload | ❌ Needs implementation | Medium |
| Password change | ❌ Needs implementation | High |
| Context displayNames | ❌ Needs model change | Low |

**QUESTIONS FOR HUMAN (need answers before API implementation):**

1. Should IPerson be a new embedded subdocument, or should we extend the existing User/Staff/Learner fields?
2. Avatar storage: API-hosted (need storage solution) or external URL only?
3. Password change: Should this be a new endpoint or should we use the existing auth flow?
4. Is the context-specific displayName feature required for MVP, or can it be deferred?

---

### HUMAN ANSWERS (2026-01-12)

**1. IPerson Type Design:** ✅ DECIDED
- Use **embedded subdocument** in Staff and Learner models
- Recommended DB representation:
  ```typescript
  // Staff model
  staff: {
    person: IPerson  // embedded subdocument
  }
  
  // Learner model  
  learner: {
    person: IPerson  // embedded subdocument
  }
  ```
- IPerson is embedded (not referenced) for atomic reads/writes
- Each userType (staff/learner) has its own person subdocument
- Allows different `preferredName` per context

**2. Avatar Storage:** ✅ DECIDED
- **Development:** Use localStorage (browser-side, no server storage)
- **Test/Production:** Use S3/Spaces/CDN in same infrastructure as system assets but different directory
- Directory structure: `{bucket}/avatars/{userId}/{filename}`
- See: `devdocs/S3_AVATAR_CONFIGURATION.md` for required configuration

**3. Password Change Flow:** ✅ DECIDED
- Password change is ONLY allowed when user is already logged in
- Recommended flow:
  1. User navigates to `/change-password` (requires authenticated session)
  2. User enters current password (verification)
  3. User enters new password + confirmation
  4. API validates current password before accepting change
  5. On success: Keep session active, show confirmation
  6. On failure: Show error, allow retry
- Endpoint: `POST /api/v2/users/me/password`
- Request: `{ currentPassword, newPassword }`
- Requires valid access token (logged in)

**4. PreferredName (Clarification):** ✅ DECIDED
- **Correction:** `displayName` is NOT context-specific
- **`preferredName`** field inside IPerson IS context-specific:
  - When on LearnerDashboard screens: use `learner.person.preferredName`
  - When on StaffDashboard screens: use `staff.person.preferredName`
- Each userType's IPerson has its own preferredName field
- Allows user to be "Alex" as a learner but "Dr. Smith" as staff

---

### API Data Model

- **Staff userType:** Has embedded `person: IPerson`
- **Learner userType:** Has embedded `person: IPerson`
- **Admin userType:** No IPerson (uses staff displayName if dual role)

**Acceptance Criteria - UI:**

- [ ] Profile routes exist and don't 404
- [ ] Page displays all IPerson fields appropriately
- [ ] Edit button next to each editable field
- [ ] Clicking Edit makes field editable
- [ ] Auto-save triggers every 2 minutes during edit
- [ ] Visual indicator when auto-save completes
- [ ] Field returns to read-only after save
- [ ] Context-specific displayName shown based on current dashboard
- [ ] Staff users can set different displayName for learner vs staff contexts
- [ ] Admin profile uses staff displayName
- [ ] Avatar upload/display works
- [ ] Form validation for required fields
- [ ] Error states shown only when validation fails
- [ ] No "unsaved changes" warning (due to auto-save)

**Acceptance Criteria - API:**

- [ ] IPerson type implemented in data model
- [ ] Staff and Learner models include person: IPerson
- [ ] GET /users/me/person endpoint returns IPerson data
- [ ] PUT /users/me/person endpoint updates with partial support
- [ ] Avatar upload/retrieval endpoints work
- [ ] Password change endpoints implemented
- [ ] Proper validation on all fields
- [ ] Sensitive data (SSN, IDs) properly encrypted
- [ ] Context-specific displayNames stored and retrieved correctly

**Related Files (UI):**
- `src/pages/profile/` - New directory
  - `LearnerProfile.tsx`
  - `StaffProfile.tsx`
  - `AdminProfile.tsx`
  - `ChangePassword.tsx` (reusable component)
- `src/features/profile/` - New feature
  - `ui/PersonForm.tsx` - Main form component
  - `ui/EditableField.tsx` - Reusable edit-button field
  - `ui/AvatarUpload.tsx`
  - `model/profileStore.ts` - Auto-save logic
  - `api/profileApi.ts`
- `src/shared/types/person.ts` - IPerson types

**Related Files (API):**
- `contracts/api/person.contract.ts` - IPerson contract
- `src/models/person.model.ts` - IPerson schema
- `src/services/person/person.service.ts`
- `src/controllers/person.controller.ts`
- `src/routes/person.routes.ts`
- Update: `src/models/user.model.ts` - Add person field to staff/learner

**Notes:**

**Auto-Save Pattern:**
- Use debounced auto-save (2 minute timer)
- Cancel timer if user manually saves or navigates away
- Visual feedback: "Saving..." → "Saved ✓" → back to read-only
- Store draft in component state, persist on save

**DisplayName Context Logic:**
- On Staff dashboard → show `person.displayNames.staff`
- On Learner dashboard → show `person.displayNames.learner`
- On Admin dashboard → show `person.displayNames.staff` (fallback)
- If displayName not set for context, fallback to `firstName lastName`

**Password Change Page:**
- Separate route: `/change-password`
- Reusable for both user password and admin password
- Fields: Current Password, New Password, Confirm New Password
- Validation: Password complexity rules
- API determines if it's user or admin session based on context

**Security Considerations:**
- SSN: Store only last 4 digits
- IDs: Encrypt sensitive ID numbers
- Passwords: Require current password for change
- Avatar: File size/type validation, virus scan
- Personal data: Appropriate access control per userType

---

