### ISS-009: Align API Client Token Handling with Auth Storage

**Priority:** high  
**Type:** bug  
**Status:** ✅ RESOLVED  
**Assigned:** UI Agent  
**Dependencies:** None  
**Resolution Date:** 2026-01-13

**Description:**
Requests from learner pages (notably `/learner/certificates`) are triggering a 401 → refresh → redirect loop. The API client reads/writes tokens from `auth-storage` while the auth store persists tokens via `tokenStorage` (`lms_access_token`), and the refresh interceptor assumes a legacy response shape. This mismatch causes missing/invalid auth headers and a forced redirect to `/login`.

**Acceptance Criteria:**
- [x] API client uses `tokenStorage` access token value for auth headers
- [x] Refresh interceptor parses the V2 response shape and stores the new access token correctly
- [x] Refresh failure clears all token storage, not just `auth-storage`
- [x] `/learner/certificates` loads without a redirect loop when authenticated
- [x] Existing API client tests updated to match the new token/refresh behavior

**Related Files:**
- `src/shared/api/client.ts`
- `src/shared/utils/tokenStorage.ts`
- `src/shared/api/client.test.ts`
- `src/pages/profile/ProfilePage.tsx`
- `src/entities/user-profile/api/userProfileApi.ts`
- `src/entities/user-profile/model/types.ts`
- `src/entities/user-profile/model/useUserProfile.ts`
- `src/entities/user-profile/model/userProfileKeys.ts`
- `src/widgets/sidebar/config/navItems.ts`
- `src/widgets/sidebar/Sidebar.tsx`
- `src/app/router/index.tsx`

**Resolution Summary:**
1. **Token Storage Alignment:** Replaced legacy `auth-storage` localStorage reads with `getAccessTokenValue()` from `tokenStorage.ts`
2. **Refresh Response Parsing:** Updated interceptor to parse V2 response shape (`response.data?.data?.accessToken`)
3. **Storage Cleanup:** `clearAuthStorage()` now calls `clearAllTokens()` plus removes legacy `auth-storage`
4. **Context-Aware Profile:** Added `UserProfileContext` type and `X-User-Type-Context` header support
5. **Dynamic Profile Routes:** Added `/staff/profile` and `/learner/profile` routes with appropriate guards
6. **Sidebar Path Resolution:** Profile nav item now returns context-specific path based on current dashboard

**Notes:**
This change aligns client behavior with `authStore` token storage and the V2 refresh contract. Fixed by Codex.

