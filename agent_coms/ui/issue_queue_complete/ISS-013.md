### ISS-013: Admin Tab Requires Escalation Password Modal

**Priority:** high
**Type:** feature
**Status:** âœ… COMPLETED (2026-01-13)
**Assigned:** UI Agent
**Dependencies:** None
**Phase 1:** commit 8e98ae9 (Escalation Modal)
**Phase 2:** commit c052af2 (Session Management)

**Description:**
Clicking on the "Admin" tab in the navigation does not prompt for an escalation password. The Admin Dashboard requires a separate password entry to enable "admin mode" before granting access. This is a security feature to prevent accidental admin actions and ensure elevated privileges are explicitly requested.

**Current Behavior:**
1. User with `global-admin` userType is logged in
2. User clicks "Admin" tab in sidebar/header navigation
3. âŒ User is taken directly to Admin Dashboard (no password prompt)
4. Admin mode is not properly activated

**Expected Behavior:**
1. User with `global-admin` userType is logged in
2. User clicks "Admin" tab in sidebar/header navigation
3. âœ… Modal appears prompting for **escalation password**
4. User enters escalation password
5. API call to `POST /api/v2/auth/escalate` with `{ escalationPassword: string }`
6. On success:
   - Store `adminToken` in **memory only** (never localStorage/sessionStorage)
   - Set `isAdminSessionActive = true` in auth store
   - Navigate to `/admin/dashboard`
   - Show admin session indicator (badge/timer)
7. On failure:
   - Show error message ("Incorrect escalation password")
   - Keep user on current page
   - Allow retry

**API Contract (already exists):**
```typescript
// POST /api/v2/auth/escalate
Request: { escalationPassword: string }

Response (success):
{
  success: true,
  data: {
    adminSession: {
      adminToken: string,
      expiresIn: 900,  // 15 minutes
      adminRoles: string[],
      adminAccessRights: string[]
    },
    sessionTimeoutMinutes: 15
  }
}

Errors:
- 401 INVALID_ESCALATION_PASSWORD - Incorrect password
- 403 NOT_ADMIN - User doesn't have global-admin userType
- 403 ADMIN_DISABLED - Admin access disabled for user
```

**UI Requirements:**

**1. Escalation Modal Component:**
- Password input field (masked)
- "Enter Admin Mode" button (primary)
- "Cancel" button (secondary)
- Error message display area
- Loading state during API call
- Focus trap within modal
- Escape key closes modal

**2. Modal Triggers:**
- Clicking "Admin" nav item when `isAdminSessionActive = false`
- Direct URL navigation to `/admin/*` routes when not escalated
- Admin-only actions that require escalation

**3. Visual Design:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ Enter Admin Mode                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Admin access requires your escalation   â”‚
â”‚  password. This is separate from your    â”‚
â”‚  login password.                         â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                         â”‚  â”‚
â”‚  â”‚ Escalation Password                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  [Incorrect password - try again]        â”‚  â† Error (hidden by default)
â”‚                                          â”‚
â”‚       [ Cancel ]    [ Enter Admin Mode ] â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4. Session Management After Escalation:**
- Admin token stored in memory only (security requirement)
- Session timeout: 15 minutes of inactivity
- Show countdown warning at 2 minutes remaining
- On timeout: 
  - Clear admin token
  - Set `isAdminSessionActive = false`
  - Redirect to Staff Dashboard
  - Show "Admin session expired" toast
- Activity resets timeout (API calls, mouse movement, key presses)

**5. Admin Session Indicator:**
- Show badge/indicator when admin mode active
- Display remaining time or "Admin Mode" label
- Click to de-escalate (with confirmation)

**Acceptance Criteria:**

**Modal Behavior:**
- [ ] Clicking Admin tab when not escalated shows password modal
- [ ] Modal has password input with masked text
- [ ] Modal has Enter Admin Mode and Cancel buttons
- [ ] Cancel closes modal, user stays on current page
- [ ] Escape key closes modal
- [ ] Clicking outside modal closes it
- [ ] Loading spinner shown during API call
- [ ] Error message shown for wrong password
- [ ] Multiple retry attempts allowed

**Escalation Success:**
- [ ] Admin token stored in memory only (verify not in storage)
- [ ] `isAdminSessionActive` set to `true`
- [ ] User navigated to `/admin/dashboard`
- [ ] Admin session indicator appears in header
- [ ] Admin nav items become accessible

**Route Protection:**
- [ ] Direct navigation to `/admin/*` shows modal if not escalated
- [ ] Admin routes inaccessible without escalation
- [ ] Staff/Learner routes remain accessible without escalation

**Session Timeout:**
- [ ] Session expires after 15 minutes of inactivity
- [ ] Warning shown at 2 minutes remaining
- [ ] On timeout: de-escalate and redirect to Staff Dashboard
- [ ] Activity resets timeout counter
- [ ] Session indicator updates remaining time

**De-escalation:**
- [ ] "Exit Admin Mode" option available in header
- [ ] Confirmation prompt before de-escalating
- [ ] On de-escalate: clear token, redirect to Staff Dashboard
- [ ] Admin nav items become inaccessible

**Security:**
- [ ] Admin token NEVER persisted to localStorage
- [ ] Admin token NEVER persisted to sessionStorage
- [ ] Admin token NEVER in cookies
- [ ] Page refresh requires re-escalation
- [ ] Browser close clears admin session

**Related Files:**
- `src/features/auth/ui/EscalationModal.tsx` (new)
- `src/features/auth/model/authStore.ts` (add escalation state)
- `src/entities/auth/api/authApi.ts` (escalateToAdmin already exists)
- `src/widgets/sidebar/Sidebar.tsx` (trigger modal on admin click)
- `src/widgets/header/Header.tsx` (admin session indicator)
- `src/app/router/guards/AdminOnlyRoute.tsx` (check escalation)
- `api/contracts/api/auth-v2.contract.ts` (escalate/deescalate contracts)

**Existing Code Reference:**
- `escalateToAdmin()` function exists in `src/entities/auth/api/authApi.ts:172`
- `isAdminSessionActive` state exists in auth store
- Auth store has escalation actions per `TRACK_1A_STATUS.md`

**Notes:**
- This is a security-critical feature to prevent accidental admin actions
- Admin password is SEPARATE from login password
- Similar to sudo pattern in Unix systems
- Consider biometric option for future enhancement
- API contract already defined in `auth-v2.contract.ts`

---


---

## Implementation Progress

### âœ… Phase 1 Complete (2026-01-13, commit: 8e98ae9)

**Implemented:**
1. **EscalationModal Component** (`src/features/auth/ui/EscalationModal.tsx`)
   - Password input with masking
   - Loading states during API call
   - Specific error messages (incorrect password, no privileges, disabled)
   - Escape key and click-outside to cancel
   - Auto-focus on password field
   - Form validation

2. **Auth Store Updates** (`src/features/auth/model/authStore.ts`)
   - Replaced mock implementation with real API call to `escalateToAdmin`
   - Uses `POST /api/v2/auth/escalate` endpoint
   - Stores admin token in memory only (security requirement)
   - Proper error handling

3. **Header Component** (`src/widgets/header/Header.tsx`)
   - Intercepts Admin tab clicks
   - Shows escalation modal if `isAdminSessionActive === false`
   - Allows direct navigation if already escalated
   - Modal state management

4. **AdminOnlyRoute Protection** (`src/app/router/ProtectedRoute.tsx`)
   - Enhanced to require active admin session
   - Checks both `global-admin` userType AND `isAdminSessionActive`
   - Redirects to staff dashboard if not escalated (triggers modal)

**Security:**
- âœ… Admin token in memory only (never persisted)
- âœ… Password verification via API
- âœ… Separate escalation password
- âœ… Session lost on refresh (by design)

### âœ… Phase 2 Complete (2026-01-13, commit: c052af2)

**Implemented:**
1. **useAdminSessionTimeout Hook** (`src/features/auth/hooks/useAdminSessionTimeout.ts`)
   - 15-minute session timeout from last activity
   - Activity tracking (mouse, keyboard, scroll, touch)
   - Warning toast at 2 minutes remaining
   - Auto de-escalation on timeout
   - Redirects to staff dashboard on expiry
   - Countdown updates every second

2. **AdminSessionIndicator Component** (`src/features/auth/ui/AdminSessionIndicator.tsx`)
   - "Admin Mode" badge with countdown timer (MM:SS)
   - Visual warning state when < 2 minutes (red badge, pulse animation)
   - De-escalation button with confirmation dialog
   - Integrated into Header component

3. **Activity Tracking:**
   - Monitors: mousedown, keydown, scroll, touchstart
   - Resets timeout on any user activity
   - Proper cleanup on session end

4. **Visual States:**
   - Normal: Blue badge with Shield icon
   - Warning: Red badge with ShieldAlert icon + pulse
   - Timer format: MM:SS countdown

**All Acceptance Criteria Met:**
- âœ… Escalation modal with password verification
- âœ… Memory-only token storage
- âœ… Admin session indicator in Header
- âœ… 15-minute session timeout
- âœ… 2-minute warning notification
- âœ… Activity tracking resets timeout
- âœ… De-escalation UI with confirmation
- âœ… Auto de-escalation on timeout
- âœ… Redirect to staff dashboard
- âœ… Route protection with escalation requirement
- âœ… Security: no persistent storage

**ISS-013 Status:** âœ… FULLY COMPLETE

