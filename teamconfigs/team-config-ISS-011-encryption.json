{
  "team": {
    "name": "ISS-011: Encrypt Identification Numbers at Rest",
    "version": "1.0.0",
    "description": "CRITICAL SECURITY: Implement AES-256-GCM encryption for sensitive PII (passport, driver's license, SSN, alien registration numbers)",
    "issue": "ISS-011",
    "priority": "critical",
    "type": "security",
    "assignedTo": "API Agent"
  },
  "mode": "security-critical-implementation",
  "issueContext": {
    "dependencies": [],
    "description": "The IIdentification.idNumber field stores sensitive PII in plain text. This is a critical security and compliance risk (FERPA, GDPR). Implement field-level encryption with key rotation support.",
    "risks": [
      "Database breach exposes PII (passports, driver's licenses)",
      "FERPA/GDPR compliance violations",
      "Backup tapes contain plain text PII",
      "Legal liability and fines"
    ],
    "fieldsToEncrypt": [
      "IIdentification.idNumber (passport, driver's license, state ID)",
      "IDemographics.alienRegistrationNumber (A-number)",
      "Future: SSN, tax ID, other sensitive identifiers"
    ],
    "encryptionStandard": "AES-256-GCM with authenticated encryption"
  },
  "workflow": {
    "pattern": "Security-First Development",
    "approach": "encryption-factory-pattern",
    "steps": [
      "1. Design: Create encryption factory with AES-256-GCM",
      "2. Utility: Implement encrypt/decrypt with key versioning",
      "3. Factory: Create field encryption decorators/helpers",
      "4. Schema: Integrate with Mongoose pre-save hooks",
      "5. Test: Comprehensive unit and integration tests",
      "6. Migration: Script to encrypt existing plain text data",
      "7. Documentation: Key management and rotation procedures",
      "8. Verification: Confirm encrypted data in database"
    ]
  },
  "agent": {
    "id": "agent-iss-011",
    "role": "Security Engineer - PII Encryption",
    "description": "Implements field-level encryption for sensitive PII with factory pattern for reusability",
    "capabilities": [
      "AES-256-GCM encryption implementation",
      "Key rotation and versioning",
      "Mongoose schema hooks integration",
      "Migration script creation",
      "Security testing and verification"
    ]
  },
  "testingStrategy": {
    "pattern": "Security-Critical Testing",
    "focus": [
      "Encrypt/decrypt round-trip correctness",
      "Key versioning and rotation",
      "Mongoose integration (pre-save hooks)",
      "Encrypted format validation",
      "Migration idempotency",
      "Error handling for missing keys"
    ],
    "commands": {
      "unit": "npm run test:unit -- encryption",
      "integration": "npm run test:integration -- identification",
      "all": "npm test",
      "specific": "npm test -- ISS-011"
    }
  },
  "securityRequirements": {
    "encryption": {
      "algorithm": "AES-256-GCM",
      "keyLength": 256,
      "ivLength": 16,
      "authTagLength": 16,
      "format": "version:iv:authTag:ciphertext"
    },
    "keyManagement": {
      "storage": "Environment variables or secrets manager",
      "never": ["Source code", "Git repos", "Docker images", "Config files in VCS"],
      "development": ".env.local (gitignored)",
      "production": "AWS Secrets Manager / HashiCorp Vault / Azure Key Vault"
    },
    "keyRotation": {
      "supported": true,
      "versionFormat": "01, 02, 03...",
      "backwardCompatible": true,
      "process": "New key version → Re-encrypt data → Deprecate old key"
    }
  },
  "implementationChecklist": {
    "encryptionUtility": [
      "[ ] Create src/utils/encryption/EncryptionFactory.ts",
      "[ ] Implement AES-256-GCM encrypt() function",
      "[ ] Implement decrypt() with version support",
      "[ ] Implement isEncrypted() validation",
      "[ ] Add key versioning support",
      "[ ] Handle missing key errors gracefully",
      "[ ] Add comprehensive JSDoc documentation"
    ],
    "schemaIntegration": [
      "[ ] Add pre-save hook to IdentificationSchema",
      "[ ] Encrypt idNumber if modified and not already encrypted",
      "[ ] Add virtual/method for decrypted access",
      "[ ] Test with Mongoose save/update operations",
      "[ ] Ensure backwards compatibility with plain text (migration phase)"
    ],
    "testing": [
      "[ ] Unit tests: encrypt/decrypt round-trip",
      "[ ] Unit tests: key versioning and rotation",
      "[ ] Unit tests: isEncrypted validation",
      "[ ] Unit tests: error handling (missing key)",
      "[ ] Integration tests: Mongoose save → read → decrypt",
      "[ ] Integration tests: verify encrypted format in DB",
      "[ ] Test migration script idempotency"
    ],
    "migration": [
      "[ ] Create scripts/migrations/encrypt-identification-numbers.ts",
      "[ ] Backup reminder before running",
      "[ ] Idempotent (safe to re-run)",
      "[ ] Progress logging",
      "[ ] Error handling and rollback strategy",
      "[ ] Dry-run mode for testing"
    ],
    "documentation": [
      "[ ] Update .env.example with ENCRYPTION_KEY",
      "[ ] Document key generation (openssl rand -hex 32)",
      "[ ] Document key rotation process",
      "[ ] Add security notes to PersonExtended.types.ts",
      "[ ] Create devdocs/ENCRYPTION.md guide",
      "[ ] Update README with encryption setup"
    ]
  },
  "factoryPattern": {
    "description": "Create reusable encryption decorators/helpers for any field",
    "benefits": [
      "Reusable across multiple schemas and fields",
      "Consistent encryption implementation",
      "Easy to add encryption to new fields",
      "Centralized key management",
      "Testable in isolation"
    ],
    "usage": {
      "schemaField": "Use createEncryptedField() helper",
      "preSaveHook": "Use encryptFieldIfModified() helper",
      "getter": "Use createDecryptedGetter() helper"
    }
  },
  "contextFiles": {
    "always": [
      "src/models/auth/PersonExtended.types.ts",
      "src/models/auth/Demographics.types.ts"
    ],
    "review": [
      "agent_coms/ui/ISSUE_QUEUE.md (ISS-011 specification)"
    ]
  },
  "workingDirectory": {
    "enforced": true,
    "path": "/home/adam/github/cadencelms_api",
    "description": "All work must be performed within this directory."
  },
  "keyFiles": {
    "encryption": "src/utils/encryption/EncryptionFactory.ts (new)",
    "schema": "src/models/auth/PersonExtended.types.ts",
    "migration": "scripts/migrations/encrypt-identification-numbers.ts (new)",
    "tests": "tests/unit/utils/encryption.test.ts (new)",
    "envExample": ".env.example",
    "docs": "devdocs/ENCRYPTION.md (new)"
  },
  "preflightChecks": [
    "Review PersonExtended.types.ts to understand IIdentification structure",
    "Check .env.example for existing encryption key documentation",
    "Verify no existing encryption implementation"
  ],
  "postImplementationChecks": [
    "Generate encryption key: openssl rand -hex 32",
    "Add ENCRYPTION_KEY to .env.local",
    "Run unit tests for encryption utility",
    "Run integration tests for Mongoose integration",
    "Test migration script with sample data",
    "Verify encrypted data format in MongoDB",
    "Document key rotation procedure"
  ]
}
